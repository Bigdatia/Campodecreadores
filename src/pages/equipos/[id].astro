---
import { Image } from "astro:assets"
import { CDN_URL } from "@/consts/urls"

import { COMBATS, REY_DE_LA_PISTA_ID } from "@/consts/combats"
import { BOXERS } from "@/consts/boxers"
import Layout from "@/layouts/Layout.astro"
import CombatFeatures from "@/sections/CombatFeatures.astro"
import CombatVideo from "@/sections/CombatVideo.astro"
import Forecasts from "@/sections/Forecasts.astro"

const getCombatById = (id: string) => {
	return COMBATS.find((combat) => combat.id === id)
}

const boxersById = new Map(BOXERS.map((boxer) => [boxer.id, boxer]))

const getBoxerNames = (boxerIds: string[]): string[] => {
	return boxerIds
		.map((boxerId) => boxersById.get(boxerId)?.name)
		.filter((name): name is string => !!name)
}

const createImgRoute = (combateNumber: number, slug: string) => {
	return `${CDN_URL}/boxers/vote/vote-${combateNumber}-${slug}.webp`
}

export const getStaticPaths = () => {
	return COMBATS.map((combat) => ({
		params: { id: combat.id },
	}))
}

const { id } = Astro.params
const combatData = getCombatById(id)
const boxerNames = combatData ? getBoxerNames(combatData.boxers) : []

if (!combatData) {
	return new Response(null, { status: 404 })
}

const { teams, boxers } = combatData
const slugs = teams ?? boxers

const image1 = slugs[0]
	? { alt: slugs[0].replaceAll("-", " "), src: createImgRoute(combatData.number, slugs[0]) }
	: null

const image2 = slugs[1]
	? { alt: slugs[1].replaceAll("-", " "), src: createImgRoute(combatData.number, slugs[1]) }
	: null

const formatter = new Intl.ListFormat("es", {
	style: "short",
	type: "conjunction",
})

const formattedBoxerNames = formatter.format(boxerNames)
const [imageWidth, imageHeight] = combatData.titleSize
const isKingOfTheHill = combatData.id === REY_DE_LA_PISTA_ID

export const prerender = true
---

<Layout
	title={`${combatData.title}· Combate #${combatData.number} de La Velada del Año IV`}
	description={`Combate entre ${formattedBoxerNames} en La Velada del Año IV`}
	image={`${CDN_URL}/matches/og-${id}-min.jpg`}
>
	<main class="md:-mt-12">
		<div
			class="full-width relative z-[-10] flex h-[60vh] w-screen items-center justify-center overflow-x-clip md:h-[76vh]"
		>
			{
				!isKingOfTheHill && image1 && (
					<img
						transition:name={`${combatData.id}-member-1`}
						decoding="async"
						src={image1.src}
						alt={image1.alt}
						class:list={[
							"boxer-image",
							"relative left-36 h-[600px] w-auto md:h-[1000px] xl:-left-10 xl:h-[1200px]",
						]}
					/>
				)
			}
			<div transition:name={`title-image-${id}`}>
				<Image
					width={imageWidth}
					height={imageHeight}
					loading={"eager"}
					class="inset-0 z-10 h-auto max-h-96 max-w-80 scale-100 object-contain sm:scale-110 lg:max-w-xl lg:scale-90"
					src={`${CDN_URL}/matches/title-${id}.webp`}
					alt={`Fotografía del combate entre ${boxerNames.join(", ")}`}
				/>
			</div>
			{
				!isKingOfTheHill && image2 && (
					<img
						transition:name={`${combatData.id}-member-2`}
						decoding="async"
						src={image2.src}
						alt={image2.alt}
						class:list={[
							"boxer-image",
							"relative right-36 h-[600px] w-auto md:h-[1000px] xl:-right-10 xl:h-[1200px]",
						]}
					/>
				)
			}
		</div>
		<CombatVideo combatId={id} />
		<div class="pointer-events-auto">
			{combatData.boxers.length <= 4 && <CombatFeatures boxerIds={combatData.boxers} />}
		</div>
		<Forecasts combatId={id} />
	</main>
</Layout>

<style>
	.full-width {
		width: 100vw;
		position: relative;
		left: 50%;
		right: 50%;
		margin-left: -50vw;
		margin-right: -50vw;
	}

	.boxer-image {
		mask-image: linear-gradient(black 90%, transparent 100%);
	}
</style>
